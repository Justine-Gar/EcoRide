{% extends 'profile/admin.html.twig' %}

{% block Main %}
	<div class="col-md-9 ms-sm-auto col-lg-10 profil-admin">
		<div class=" pt-3 pb-2 mb-3 border-bottom">
			<div class="text-center">
				<h2>Tableau de bord</h2>
			</div>
		</div>

		<!-- Flash messages -->
		{% for label, messages in app.flashes %}
			{% for message in messages %}
				<div class="alert alert-{{ label }} alert-dismissible fade show" role="alert">
					{{ message }}
					<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
				</div>
			{% endfor %}
		{% endfor %}

		<!-- Stats Cards -->
		<div class="row m-3">
			<div class="col-xl-3 col-md-6 mb-4">
				<div class="card shadow h-100 py-2">
					<div class="card-body">
						<div class="row no-gutters align-items-center">
							<div class="col mr-2">
								<div class="text-xs text-title mb-1">
									Total Crédits Plateforme</div>
								<div class="h5 mb-0 font-weight-bold text-gray-800">{{ adminCredits }}</div>
							</div>
							<div class="col-auto">
								<i class="fas fa-coins fa-2x text-gray-300"></i>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>


		<!-- Charts -->
		<div class="row m-3">
			<div class="col-xl-6">
				<div class="card shadow mb-4">
					<div class="card-header py-3">
						<h6 class="m-0 text-title">Nombre de covoiturages par mois</h6>
					</div>
					<div class="card-body">
						<div class="chart-area">
							<canvas id="carpoolChart" height="300"></canvas>
						</div>
					</div>
				</div>
			</div>
			<div class="col-xl-6">
				<div class="card shadow mb-4">
					<div class="card-header py-3">
						<h6 class="m-0 text-title">Crédits gagnés par mois</h6>
					</div>
					<div class="card-body">
						<div class="chart-area">
							<canvas id="creditsChart" height="300"></canvas>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
{% endblock %}

{% block javascripts %}
	{{ parent() }}
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
	<script src="{{ asset('assets/js/graphicAdmin.js') }}"></script>
	
	<!-- ===== AJOUT : Script MongoDB ===== -->
	<script>
	document.addEventListener('DOMContentLoaded', function() {
		const checkBtn = document.getElementById('check-mongodb-btn');
		const migrateBtn = document.getElementById('migrate-btn');
		const statusDiv = document.getElementById('migration-status');

		// Vérifier le statut automatiquement au chargement
		checkMongoDBStatus();

		// Événement pour vérifier le statut
		checkBtn.addEventListener('click', checkMongoDBStatus);

		// Événement pour migrer
		migrateBtn.addEventListener('click', function() {
			if (confirm('Êtes-vous sûr de vouloir migrer les données vers MongoDB ? Cette opération peut prendre quelques minutes.')) {
				migrateCarpoolData();
			}
		});

		function checkMongoDBStatus() {
			checkBtn.disabled = true;
			checkBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Vérification...';

			fetch('/admin/mongodb-status')
				.then(response => response.json())
				.then(data => {
					if (data.success) {
						updateStatusDisplay(data);
					} else {
						showError('Erreur lors de la vérification : ' + data.message);
					}
				})
				.catch(error => {
					showError('Erreur de connexion : ' + error.message);
				})
				.finally(() => {
					checkBtn.disabled = false;
					checkBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Vérifier';
				});
		}

		function migrateCarpoolData() {
			migrateBtn.disabled = true;
			migrateBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Migration...';

			fetch('/admin/migrate-carpool-data')
				.then(response => response.json())
				.then(data => {
					if (data.success) {
						statusDiv.className = 'alert alert-success';
						statusDiv.innerHTML = `
							<div class="d-flex align-items-center">
								<i class="fas fa-check-circle me-2"></i>
								<div>
									<strong>Migration terminée !</strong><br>
									<small>${data.migrated} covoiturages migrés sur ${data.total} total</small>
								</div>
							</div>
						`;
						migrateBtn.disabled = true;
						migrateBtn.innerHTML = '<i class="fas fa-check"></i> Migré';
						
						// Recharger les graphiques
						if (typeof fetchCarpoolsData === 'function') {
							fetchCarpoolsData();
						}
						if (typeof fetchCreditsData === 'function') {
							fetchCreditsData();
						}
					} else {
						showError('Erreur lors de la migration : ' + data.message);
					}
				})
				.catch(error => {
					showError('Erreur de connexion : ' + error.message);
				})
				.finally(() => {
					migrateBtn.disabled = false;
					migrateBtn.innerHTML = '<i class="fas fa-database"></i> Migrer';
				});
		}

		function updateStatusDisplay(data) {
			const percentage = data.migration_percentage || 0;
			
			if (data.needs_migration) {
				statusDiv.className = 'alert alert-warning';
				statusDiv.innerHTML = `
					<div class="d-flex justify-content-between align-items-center">
						<div>
							<i class="fas fa-exclamation-triangle me-2"></i>
							<strong>Migration recommandée</strong><br>
							<small>MySQL: ${data.mysql_carpools} covoiturages | MongoDB: ${data.mongodb_analytics} analytics (${percentage}%)</small>
						</div>
						<div class="progress" style="width: 100px; height: 20px;">
							<div class="progress-bar bg-warning" style="width: ${percentage}%"></div>
						</div>
					</div>
				`;
				migrateBtn.disabled = false;
			} else {
				statusDiv.className = 'alert alert-success';
				statusDiv.innerHTML = `
					<div class="d-flex align-items-center">
						<i class="fas fa-check-circle me-2"></i>
						<div>
							<strong>MongoDB synchronisé !</strong><br>
							<small>${data.mongodb_analytics} analytics disponibles</small>
						</div>
					</div>
				`;
				migrateBtn.disabled = true;
				migrateBtn.innerHTML = '<i class="fas fa-check"></i> À jour';
			}
		}

		function showError(message) {
			statusDiv.className = 'alert alert-danger';
			statusDiv.innerHTML = `
				<div class="d-flex align-items-center">
					<i class="fas fa-exclamation-circle me-2"></i>
					<div>
						<strong>Erreur</strong><br>
						<small>${message}</small>
					</div>
				</div>
			`;
			migrateBtn.disabled = true;
		}
	});
	</script>
	<!-- ===== FIN AJOUT ===== -->

{% endblock %}