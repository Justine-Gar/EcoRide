{% extends 'base.html.twig' %}

{% block title %}Rapport d'activité{% endblock %}

{% block stylesheets %}
    <link rel="stylesheet" href="{{ asset('assets/css/pages/dashboard/profilUser.css') }}">
    <style>
        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 2rem;
        }
        .stats-card {
            border-radius: 0.5rem;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            transition: transform 0.3s;
        }
        .stats-card:hover {
            transform: translateY(-5px);
        }
        .stat-icon {
            font-size: 2rem;
            opacity: 0.8;
        }
        .timeline {
            position: relative;
            padding: 1rem 0;
        }
        .timeline::before {
            content: '';
            position: absolute;
            height: 100%;
            width: 2px;
            background: #e9ecef;
            left: 50px;
            top: 0;
        }
        .timeline-item {
            display: flex;
            margin-bottom: 1.5rem;
        }
        .timeline-date {
            width: 100px;
            text-align: right;
            padding-right: 1.5rem;
        }
        .timeline-content {
            flex: 1;
        }
    </style>
{% endblock %}

{% block body %}
<!--=============START MAIN============-->
<main class="container profil-staff">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3 mb-5">
            <div class="card">
                <div class="card-body text-center">
                    <div class="mb-3">
                        {% if user.profilPicture %}
                            <img src="{{ asset('uploads/profile_pictures/' ~ user.profilPicture) }}" alt="Photo de profil" class="rounded-circle profile-pic">
                        {% else %}
                            <div class="default-profile-pic">
                                <i class="fas fa-user fa-3x"></i>
                            </div>
                        {% endif %}
                    </div>
                    <h5 class="card-title">{{ user.firstname }} {{ user.name }}</h5>
                    <p class="card-text text-muted">Employé EcoRide</p>
                    <hr>
                    <div class="d-grid gap-2">
                        <a href="{{ path('app_staff') }}" class="btn btn-primary btn-sm mb-2">
                            <i class="fas fa-tachometer-alt me-1"></i>Tableau de bord
                        </a>
                        <a href="{{ path('app_staff_history') }}" class="btn btn-outline-primary btn-sm mb-2">
                            <i class="fas fa-history me-1"></i>Historique des actions
                        </a>
                        <a href="{{ path('app_staff_report') }}" class="btn btn-outline-info btn-sm active">
                            <i class="fas fa-chart-bar me-1"></i>Rapport d'activité
                        </a>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="col-md-9 mb-5">
            <!-- Period Selection -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h5 class="mb-0">
                                <i class="fas fa-chart-bar me-1"></i>Rapport d'activité
                            </h5>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex justify-content-md-end">
                                <div class="input-group">
                                    <span class="input-group-text">Période</span>
                                    <select class="form-select" id="report-period">
                                        <option value="week">Cette semaine</option>
                                        <option value="month" selected>Ce mois</option>
                                        <option value="quarter">Ce trimestre</option>
                                        <option value="year">Cette année</option>
                                    </select>
                                    <button class="btn btn-primary" id="generate-report">
                                        <i class="fas fa-sync-alt me-1"></i>Actualiser
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Summary Stats -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card stats-card bg-primary text-white">
                        <div class="card-body text-center">
                            <div class="stat-icon mb-2">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <h3 class="mb-1">45</h3>
                            <p class="mb-0">Avis approuvés</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stats-card bg-danger text-white">
                        <div class="card-body text-center">
                            <div class="stat-icon mb-2">
                                <i class="fas fa-times-circle"></i>
                            </div>
                            <h3 class="mb-1">8</h3>
                            <p class="mb-0">Avis rejetés</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stats-card bg-success text-white">
                        <div class="card-body text-center">
                            <div class="stat-icon mb-2">
                                <i class="fas fa-flag-checkered"></i>
                            </div>
                            <h3 class="mb-1">12</h3>
                            <p class="mb-0">Signalements résolus</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stats-card bg-info text-white">
                        <div class="card-body text-center">
                            <div class="stat-icon mb-2">
                                <i class="fas fa-tasks"></i>
                            </div>
                            <h3 class="mb-1">65</h3>
                            <p class="mb-0">Total des actions</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Charts -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">Actions par jour</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="actionsPerDayChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">Répartition des actions</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="actionsDistributionChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Performance Metrics -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Métriques de performance</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-4">
                                <h6>Temps moyen de modération d'un avis</h6>
                                <div class="progress" style="height: 20px;">
                                    <div class="progress-bar bg-success" role="progressbar" style="width: 85%;" aria-valuenow="85" aria-valuemin="0" aria-valuemax="100">
                                        <span class="fw-bold">2,5 heures</span>
                                    </div>
                                </div>
                                <small class="text-muted">Objectif: 4 heures</small>
                            </div>
                            <div class="mb-4">
                                <h6>Temps moyen de résolution d'un signalement</h6>
                                <div class="progress" style="height: 20px;">
                                    <div class="progress-bar bg-warning" role="progressbar" style="width: 65%;" aria-valuenow="65" aria-valuemin="0" aria-valuemax="100">
                                        <span class="fw-bold">5,2 heures</span>
                                    </div>
                                </div>
                                <small class="text-muted">Objectif: 4 heures</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-4">
                                <h6>Avis modérés par jour</h6>
                                <div class="progress" style="height: 20px;">
                                    <div class="progress-bar bg-primary" role="progressbar" style="width: 90%;" aria-valuenow="90" aria-valuemin="0" aria-valuemax="100">
                                        <span class="fw-bold">18 avis/jour</span>
                                    </div>
                                </div>
                                <small class="text-muted">Objectif: 15 avis/jour</small>
                            </div>
                            <div class="mb-4">
                                <h6>Taux de satisfaction des utilisateurs</h6>
                                <div class="progress" style="height: 20px;">
                                    <div class="progress-bar bg-info" role="progressbar" style="width: 95%;" aria-valuenow="95" aria-valuemin="0" aria-valuemax="100">
                                        <span class="fw-bold">95%</span>
                                    </div>
                                </div>
                                <small class="text-muted">Objectif: 90%</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Recent Activity -->
            <div class="card">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Activité récente</h5>
                    <a href="{{ path('app_staff_history') }}" class="btn btn-sm btn-outline-primary">Voir tout l'historique</a>
                </div>
                <div class="card-body">
                    <div class="timeline">
                        <div class="timeline-item">
                            <div class="timeline-date">
                                <span class="badge bg-primary">Aujourd'hui</span>
                            </div>
                            <div class="timeline-content">
                                <p><strong>10:45</strong> - Vous avez approuvé l'avis de <strong>Marie Martin</strong> concernant le covoiturage <strong>Paris → Lyon</strong>.</p>
                            </div>
                        </div>
                        
                        <div class="timeline-item">
                            <div class="timeline-date">
                                <span class="badge bg-primary">Aujourd'hui</span>
                            </div>
                            <div class="timeline-content">
                                <p><strong>10:30</strong> - Vous avez rejeté l'avis de <strong>Pierre Dupont</strong> concernant le covoiturage <strong>Marseille → Nice</strong>.</p>
                            </div>
                        </div>
                        
                        <div class="timeline-item">
                            <div class="timeline-date">
                                <span class="badge bg-secondary">Hier</span>
                            </div>
                            <div class="timeline-content">
                                <p><strong>15:20</strong> - Vous avez résolu le signalement concernant le covoiturage <strong>Bordeaux → Toulouse</strong>.</p>
                            </div>
                        </div>
                        
                        <div class="timeline-item">
                            <div class="timeline-date">
                                <span class="badge bg-secondary">Hier</span>
                            </div>
                            <div class="timeline-content">
                                <p><strong>14:15</strong> - Vous avez approuvé l'avis de <strong>Thomas Bernard</strong> concernant le covoiturage <strong>Lille → Paris</strong>.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>
{% endblock %}

{% block javascripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Données pour le graphique des actions par jour
        const actionsPerDayData = {
            labels: ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'],
            datasets: [
                {
                    label: 'Avis approuvés',
                    data: [5, 8, 6, 9, 10, 4, 3],
                    backgroundColor: 'rgba(13, 110, 253, 0.5)',
                    borderColor: 'rgba(13, 110, 253, 1)',
                    borderWidth: 1
                },
                {
                    label: 'Avis rejetés',
                    data: [1, 2, 0, 1, 3, 1, 0],
                    backgroundColor: 'rgba(220, 53, 69, 0.5)',
                    borderColor: 'rgba(220, 53, 69, 1)',
                    borderWidth: 1
                },
                {
                    label: 'Signalements résolus',
                    data: [2, 1, 3, 2, 1, 2, 1],
                    backgroundColor: 'rgba(25, 135, 84, 0.5)',
                    borderColor: 'rgba(25, 135, 84, 1)',
                    borderWidth: 1
                }
            ]
        };

        // Données pour le graphique de distribution des actions
        const actionsDistributionData = {
            labels: ['Avis approuvés', 'Avis rejetés', 'Signalements résolus'],
            datasets: [{
                data: [45, 8, 12],
                backgroundColor: [
                    'rgba(13, 110, 253, 0.8)',
                    'rgba(220, 53, 69, 0.8)',
                    'rgba(25, 135, 84, 0.8)'
                ],
                borderColor: [
                    'rgba(13, 110, 253, 1)',
                    'rgba(220, 53, 69, 1)',
                    'rgba(25, 135, 84, 1)'
                ],
                borderWidth: 1
            }]
        };

        // Configuration du graphique des actions par jour
        const actionsPerDayConfig = {
            type: 'bar',
            data: actionsPerDayData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    title: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0
                        }
                    }
                }
            }
        };

        // Configuration du graphique de distribution des actions
        const actionsDistributionConfig = {
            type: 'pie',
            data: actionsDistributionData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    title: {
                        display: false
                    }
                }
            }
        };

        // Initialisation des graphiques
        const actionsPerDayChart = new Chart(
            document.getElementById('actionsPerDayChart'),
            actionsPerDayConfig
        );

        const actionsDistributionChart = new Chart(
            document.getElementById('actionsDistributionChart'),
            actionsDistributionConfig
        );

        // Gestionnaire d'événement pour le bouton de génération de rapport
        document.getElementById('generate-report').addEventListener('click', function() {
            const period = document.getElementById('report-period').value;
            
            // Simule un chargement
            this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Chargement...';
            this.disabled = true;
            
            // Simule une actualisation des données (à remplacer par un vrai appel AJAX)
            setTimeout(() => {
                // Mise à jour des graphiques avec de nouvelles données simulées
                if (period === 'week') {
                    actionsPerDayData.datasets[0].data = [3, 5, 4, 7, 8, 2, 1];
                    actionsPerDayData.datasets[1].data = [0, 1, 1, 2, 1, 0, 0];
                    actionsPerDayData.datasets[2].data = [1, 0, 2, 1, 1, 1, 0];
                    
                    actionsDistributionData.datasets[0].data = [30, 5, 6];
                } else if (period === 'month') {
                    actionsPerDayData.datasets[0].data = [5, 8, 6, 9, 10, 4, 3];
                    actionsPerDayData.datasets[1].data = [1, 2, 0, 1, 3, 1, 0];
                    actionsPerDayData.datasets[2].data = [2, 1, 3, 2, 1, 2, 1];
                    
                    actionsDistributionData.datasets[0].data = [45, 8, 12];
                } else if (period === 'quarter') {
                    actionsPerDayData.datasets[0].data = [18, 22, 25, 30, 28, 15, 12];
                    actionsPerDayData.datasets[1].data = [3, 5, 2, 4, 6, 2, 1];
                    actionsPerDayData.datasets[2].data = [5, 4, 7, 6, 4, 5, 3];
                    
                    actionsDistributionData.datasets[0].data = [150, 23, 34];
                } else if (period === 'year') {
                    actionsPerDayData.datasets[0].data = [45, 55, 60, 65, 70, 40, 35];
                    actionsPerDayData.datasets[1].data = [8, 12, 6, 10, 15, 5, 3];
                    actionsPerDayData.datasets[2].data = [12, 10, 15, 14, 11, 13, 8];
                    
                    actionsDistributionData.datasets[0].data = [370, 59, 83];
                }
                
                actionsPerDayChart.update();
                actionsDistributionChart.update();
                
                // Réinitialisation du bouton
                this.innerHTML = '<i class="fas fa-sync-alt me-1"></i>Actualiser';
                this.disabled = false;
                
                // Ajout d'une notification de succès
                const alertContainer = document.createElement('div');
                alertContainer.className = 'alert alert-success alert-dismissible fade show mt-3';
                alertContainer.innerHTML = `
                    <i class="fas fa-check-circle me-1"></i> Rapport actualisé avec succès pour la période : ${document.getElementById('report-period').options[document.getElementById('report-period').selectedIndex].text}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `;
                
                const cardBody = this.closest('.card-body');
                cardBody.appendChild(alertContainer);
                
                // Auto-suppression de l'alerte après 3 secondes
                setTimeout(() => {
                    const alert = cardBody.querySelector('.alert');
                    if (alert) {
                        alert.remove();
                    }
                }, 3000);
            }, 1000);
        });
    });
</script>
{% endblock %}